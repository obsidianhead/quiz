<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Question Generator</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="form-container" class="container my-5 p-4 bg-white rounded shadow">
        <!-- Display Course Name Here -->
        <h1 id="course-name" class="text-center mb-4">Select Course</h1>
        <h2 class="text-center mb-4">Add Quiz Question</h2>

        <!-- Status message for loading JSON -->
        <div id="status" class="text-center mb-3 text-danger"></div>

        <form id="question-form" class="mb-4">
            <div class="form-group">
                <label for="course">Course:</label>
                <select id="course" name="course" class="form-control" required>
                    <!-- Course options will be populated dynamically -->
                </select>
            </div>

            <div class="form-group">
                <label for="chapter">Chapter:</label>
                <select id="chapter" name="chapter" class="form-control" required disabled>
                    <!-- Chapter options will be populated dynamically after course is selected -->
                </select>
            </div>

            <div class="form-group">
                <label for="question">Question:</label>
                <textarea id="question" name="question" class="form-control" rows="3" required></textarea>
            </div>

            <!-- Dropdown for Optional Image Selection -->
            <div class="form-group">
                <label for="image-select">Select Image (optional):</label>
                <select id="image-select" name="image-select" class="form-control">
                    <option value="">None</option>
                    <!-- Image options will be populated dynamically -->
                </select>
            </div>

            <label>Answers:</label>
            <div id="answers" class="btn-container mb-3">
                <div class="d-flex align-items-center mb-2">
                    <input type="text" name="answer" class="form-control mr-2" placeholder="Answer 1" required>
                    <div class="form-check">
                        <input type="radio" name="correct" class="form-check-input" value="0">
                        <label class="form-check-label">Correct</label>
                    </div>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <input type="text" name="answer" class="form-control mr-2" placeholder="Answer 2" required>
                    <div class="form-check">
                        <input type="radio" name="correct" class="form-check-input" value="1">
                        <label class="form-check-label">Correct</label>
                    </div>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <input type="text" name="answer" class="form-control mr-2" placeholder="Answer 3" required>
                    <div class="form-check">
                        <input type="radio" name="correct" class="form-check-input" value="2">
                        <label class="form-check-label">Correct</label>
                    </div>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <input type="text" name="answer" class="form-control mr-2" placeholder="Answer 4" required>
                    <div class="form-check">
                        <input type="radio" name="correct" class="form-check-input" value="3">
                        <label class="form-check-label">Correct</label>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-primary btn-block" onclick="addQuestion()">Add Question</button>
        </form>
        <h3 class="text-center mb-4">Generated JSON</h3>
        <textarea id="output" class="form-control mb-4" rows="10" readonly></textarea>
        <button class="btn btn-success btn-block" onclick="downloadJSON()">Download Updated JSON</button>
    </div>

    <!-- Include Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- JavaScript for quiz question generator -->
    <script>
        let questions = [];
        let config = {
            courseName: '',
            chapters: []
        };
        let images = []; // To store available images
        let selectedCourse = null; // Track the selected course
        let selectedChapter = null; // Track the selected chapter

        // Load courses, chapters, and configuration JSON automatically
        document.addEventListener('DOMContentLoaded', () => {
            loadCourses(); // Load available courses
            loadImagesFromAssets(); // Load images from assets folder
        });

        function loadCourses() {
        fetch('courses.json') // Assuming there's a JSON file listing available courses
                .then(response => response.json())
                .then(data => {
                    const courseSelect = document.getElementById('course');
                    courseSelect.innerHTML = '<option value="" disabled selected>Select a course</option>';

                    data.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id; // Assuming courses have an 'id' field
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                    });

                    // Trigger chapter loading when a course is selected
                    courseSelect.addEventListener('change', function () {
                    selectedCourse = this.value;
                    loadChapters(selectedCourse); // Load chapters for the selected course
                    });
                })
                .catch(error => {
                    console.error('Error loading courses:', error);
                    document.getElementById('status').innerText = 'Failed to load courses. Please check the file.';
                });
        }

        function loadChapters(courseId) {
            const chapterSelect = document.getElementById('chapter');
            chapterSelect.disabled = true; // Disable the chapter select until chapters are loaded
            chapterSelect.innerHTML = '<option value="" disabled selected>Select a chapter</option>';

            fetch(`./data/${courseId}/quiz_config.json`)
            .then(response => response.json())
            .then(data => {
            config = data;
            document.getElementById('course-name').innerText = config.courseName;

                    // Populate chapters
                    config.chapters.forEach(chapter => {
                    const option = document.createElement('option');
                        option.value = chapter.number; // Store chapter number in value
                        option.textContent = chapter.name; // Display chapter name
                        chapterSelect.appendChild(option);
                        });

                    chapterSelect.disabled = false; // Enable chapter selection

                    chapterSelect.addEventListener('change', function () {
                    selectedChapter = this.value;
                        loadExistingJSON(selectedChapter); // Load questions for the selected chapter
                        });
                })
                .catch(error => {
                console.error('Error loading chapters:', error);
                document.getElementById('status').innerText =
                'Failed to load chapters for the selected course.';
                });
                }

        function loadExistingJSON(chapter) {
        if (!chapter) {
        document.getElementById('status').innerText = 'Please select a chapter.';
        return;
            }

            const chapterQuestionsFile = `./data/${selectedCourse}/chapters/${chapter}/questions.json`;

            fetch(chapterQuestionsFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load existing questions.');
                    }
                    return response.json();
                })
                .then(data => {
                    questions = Array.isArray(data) ? data : [];
                    updateOutput();
                    document.getElementById('status').innerText =
                        `Loaded questions for Chapter ${chapter} successfully!`;
                })
                .catch(error => {
                    console.error('Error loading JSON:', error);
                    questions = []; // Start with an empty array if loading fails
                    document.getElementById('status').innerText =
                        `Failed to load questions for Chapter ${chapter}. Starting with an empty set.`;
                });
        }

        function loadImagesFromAssets() {
            fetch('assets/images.json') // Assuming there's a JSON file listing the images
                .then(response => response.json())
                .then(data => {
                    images = data;
                    populateFormOptions();
                })
                .catch(error => {
                    console.error('Error loading images from assets folder:', error);
                    document.getElementById('status').innerText =
                        'Failed to load images. Please check assets folder.';
                });
        }

        function populateFormOptions() {
        const imageSelect = document.getElementById('image-select');

        // Clear existing options
        imageSelect.innerHTML = '<option value="">None</option>'; // Reset image options with the default "None"

        // Populate images
        images.forEach(image => {
        const option = document.createElement('option');
        option.value = `assets/${image}`;
        option.textContent = image;
        imageSelect.appendChild(option);
        });
        }

        function addQuestion() {
            const chapter = document.getElementById('chapter').value;
            const questionText = document.getElementById('question').value;
            const imageUrl = document.getElementById('image-select').value;
            const answersElements = document.querySelectorAll('input[name="answer"]');
            const correctElement = document.querySelector('input[name="correct"]:checked');

            if (!correctElement) {
                alert('Please select a correct answer.');
                return;
            }

            const correctIndex = parseInt(correctElement.value);
            let answers = [];

            answersElements.forEach((answerElement, index) => {
                const answerText = answerElement.value.trim();

                if (answerText) {
                    answers.push({
                    text: answerText,
                    correct: index === correctIndex // Determine if this is the correct answer
                    });
                }
            });

            if (answers.length === 0) {
                alert('Please provide at least one answer.');
                return;
            }

            const questionObject = {
                question: questionText,
                image: imageUrl ? imageUrl : null, // Include image URL if selected
                answers: answers
            };

            questions.push(questionObject);
            document.getElementById('question-form').reset();
            updateOutput();
            loadExistingJSON(chapter);
        }

        function updateOutput() {
            document.getElementById('output').value = JSON.stringify(questions, null, 2);
        }

        function downloadJSON() {
            if (!selectedChapter) {
                alert('Please select a chapter to download questions for.');
                return;
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questions, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `questions_chapter_${selectedChapter}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>

</html>
